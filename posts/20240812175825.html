<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="IC后端-pnr全流程, 洛友">
    <meta name="description" content="Notes,Articals etc.">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>IC后端-pnr全流程 | 洛友</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 7.3.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/favicon.svg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">洛友</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/favicon.svg" class="logo-img circle responsive-img">
        
        <div class="logo-name">洛友</div>
        <div class="logo-desc">
            
            Notes,Articals etc.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121825280.png')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">IC后端-pnr全流程</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%90%8E%E7%AB%AF/">
                                <span class="chip bg-color">后端</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E8%8A%AF%E7%89%87%E8%AE%BE%E8%AE%A1/" class="post-category">
                                芯片设计
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2024-08-12
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    3.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    14 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="1-课题组项目统一文件结构"><a href="#1-课题组项目统一文件结构" class="headerlink" title="1. 课题组项目统一文件结构"></a>1. 课题组项目统一文件结构</h2><blockquote>
<p>请注意三个路径 <code>MY_LIB_DIR</code>, <code>MY_PROJ_DIR</code>以及<code>BACKEND_DIR</code><br>这三个路径在脚本中会经常用到的。</p>
</blockquote>
<pre class="line-numbers language-mindmap" data-language="mindmap"><div class="caption"><span>> 500</span></div><code class="language-mindmap">## 后端环境
- TSMC22lib(脚本库端)
&#96;MY_LIB_DIR&#96;
	- Makefile
	- technology
	- settings
		- Makefile_globalsettings
		- template_localsettings
		- template_project_settings
	- synthesis
	- pnr
	- starrc
	- pt_flow
	- etc.
- 项目文件夹(项目端)
&#96;MY_PROJ_DIR&#96;
	- Makefile
	- rtl
	- simv
	- spyglass
	- BACKEND.
	&#96;BACKEND_DIR&#96;
		- Makefile_localsettings
		- synthesis
		- pnr
		- starrc
		- pt_flow<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="2-流程初始化"><a href="#2-流程初始化" class="headerlink" title="2. 流程初始化"></a>2. 流程初始化</h2><ol>
<li>从<code>LIB_DIR</code>路径下复制一份<code>Makefile</code>，到项目文件夹<code>MY_PROJ_DIR</code>路径下（即自己的项目根路径）。</li>
<li>执行<code>make NAME=YourDesignName all</code>. 例如,我的项目顶层叫做ISP，那就是<code>make NAME=ISP all</code></li>
<li>第二步会在当前路径下生成<code>BACKEND</code>文件夹，里面包含了<code>synthesis</code>，<code>pnr</code>，<code>starrc</code>，<code>pt_flow</code>等文件夹，各个步骤的脚本均已经初始化完成。</li>
</ol>
<h2 id="3-整体流程介绍"><a href="#3-整体流程介绍" class="headerlink" title="3.  整体流程介绍"></a>3.  整体流程介绍</h2><p>初始化完成之后， 我们将目光放在<code>pnr</code>这里。  （做pr需要提前准备好综合的网表和sdc约束文件，请参考dc综合部分.下文<code>数据准备</code>部分有详细介绍）</p>
<p>进入<code>pnr</code>路径之后，里面会有一个<code>run_pr</code>文本文件，打开之后如下图所示，包含了在做pnr的过程中各个步骤，可以自己修改需要跑哪一部分（注释或者取消注释即可）</p>
<blockquote>
<p>最后3个带open的命令，就是字面意思，打开对应的block。 比如说我们做完了place_opt之后，想打开结果查看一下，就可以执行open_palce_opt命令</p>
</blockquote>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121801339.png"></p>
<p>下图简单展示一下流程的具体情况。</p>
<ol>
<li><code>init_design</code> 是进行 floorplan的， 需要手动摆放macro以及pin， 同时设置电源条线。</li>
<li><code>place_opt</code> -&gt; <code>route_opt</code> 主要是跑脚本， 一般没问题的话，就直接一起跑就好了</li>
<li><code>route</code>完了之后，要进行 <code>timing_eco</code>。 通过 <code>starrc</code> 和 <code>pt</code>修复时序。 这一步需要重复执行直到没有时序错误为止。</li>
<li>然后就可以插入 filler， 保存为<code>chip_finish</code></li>
<li>通过<code>write_data</code>,可以导出所有后续需要的文件.</li>
<li>然后就可以calibre里面进行<code>lvs</code>和<code>drc</code>检查了。<br><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121806964.png"></li>
</ol>
<h2 id="4-数据准备"><a href="#4-数据准备" class="headerlink" title="4. 数据准备"></a>4. 数据准备</h2><h3 id="Makefile-localsettings"><a href="#Makefile-localsettings" class="headerlink" title="Makefile_localsettings"></a>Makefile_localsettings</h3><p>在进行pr之前， 我们需要提前设置好使用的IP以及SRAM的相关信息，在<code>BACKEND_DIR</code>里面会有<code>Makefile_localsettings</code></p>
<p>pr需要设置<code>ndm_list</code>,将使用到的ndm添加即可</p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121806121.png"></p>
<h3 id="netlist"><a href="#netlist" class="headerlink" title="netlist"></a>netlist</h3><p>综合生成的网表文件, 保存在<code>synthesis/outputs</code>即可,无需移动.</p>
<h3 id="sdc"><a href="#sdc" class="headerlink" title="sdc"></a>sdc</h3><blockquote>
<p><code>synthesis</code>使用的<code>sdc</code>文件放在<code>synthesis/inputs</code>文件夹内.<br><code>synthesis</code>之后的步骤(pr,pt)使用的<code>sdc</code>文件是dc工具生成的sdc,放在<code>synthesis/outputs</code>内.<br>脚本中已经设置了对应的路径, 不要轻易移动,检查确认即可.</p>
</blockquote>
<p>synthesis使用的sdc和之后步骤使用的sdc有所不同,需要手动进行修改:</p>
<ol>
<li>在<code>synthesis</code>的时候,我们的sdc会设置<code>ideal_network</code>以及<code>uncertainty</code>等.<br>在pr以及pt的时候,已经有具体的物理版图信息了,就不需要这个设置了,需要修改sdc将其注释掉.</li>
<li>设置<code>driving_cell</code>的时候, synthesis是这样设置的<br><code>set_driving_cell -library tcbn22ullbwp30p140ssg0p81vm40c -lib_cell INVD4BWP30P140 -pin ZN [get_ports *]</code><br>PT时因为是多个corner同时进行STA,因此不需要指定<code>library</code>选项,改为<br><code>set_driving_cell -lib_cell INVD4BWP30P140  [get_ports *]</code>即可</li>
</ol>
<h2 id="5-init-design"><a href="#5-init-design" class="headerlink" title="5. init_design"></a>5. init_design</h2><p>将<code>run_pr</code>的内容,除了第一行全部注释, 然后在命令行执行<code>./run_pr</code>, 进行<code>init_deisgn</code>.</p>
<blockquote>
<p>执行完该步骤，会在pnr的路径下，生成<code>project_settings</code>文件,里面包含了pr所用到的一些工艺文件,感兴趣的可以了解一下.</p>
</blockquote>
<h3 id="进行floorplan"><a href="#进行floorplan" class="headerlink" title="进行floorplan"></a>进行floorplan</h3><p>脚本执行完毕后, 会自动打开icc2的gui界面. 这时需要进行floorplan,包含以下几个步骤:</p>
<ol>
<li>初始化core的面积<br>脚本默认会获取设计的面积, 按照30%填充率进行初始化,一般需要设计者重新声明一下,按照自己项目的需求进行初始化.<code>initialize_floorplan</code></li>
<li>sram等macro的摆放.<br>需要按照数据流向来摆放,否则后面布线可能会很阻塞.摆放完成需要<code>fix</code>住.<br>要善用<code>flyline</code>以及<code>register_trace</code>功能,时刻检查数据流向</li>
<li>摆放pin<br>命令为<code>create_pin_guide</code>。 示例如下：</li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">create_pin_guide -boundary &#123;&#123;x1 y1&#125; &#123;x2 y2&#125;&#125; -layers &#123;M3 M5&#125; -name pin_guide_0 [get_ports *]
place_pins -ports [get_ports *]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>如果摆错了，需要删除<code>pin_guide</code>，重新<code>place_pins</code>即可.</p>
<p><code>Remove_pin_guides *</code></p>
<ol start="4">
<li>设置 <code>placement_blockage</code> (可选)<br>具体的设置方法在<code>place_opt</code>部分说明</li>
<li>使用脚本产生电源条线<br><code>source ./user_scripts/floorplan.tcl</code></li>
<li>保存设计,必须保存为这样的名字,以便下一步脚本读取.<br><code>design_name/init_design</code></li>
</ol>
<h3 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h3><p>做完<code>floorplan</code>之后，需要执行下列的命令进行检查。</p>
<p>执行完命令之后 <code>view-&gt;error browser </code>查看具体的错误信息。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">check_boundary_cells
check_pg_missing_vias
check_pg_drc
check_pg_connectivity<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>总共需要检查以下几项内容:</p>
<ol>
<li><code>core height</code> 是否为 0.9 整数倍</li>
<li><code>ports</code> 是否已放置</li>
<li>ram 放置是否符合数据流向，是否放在 core 区域<strong>边缘内</strong>并 <code>fix 住</code><br>（如果 block 超过 1200x1200，有无放置 clamp cell 及 tcd cell 并创建其 keepout margin 及 routing blockage）</li>
<li>有无 <code>source ./user_scripts/floorplan.tcl</code> 创建 boundary cell、tap cell 及电源线</li>
<li>View-&gt;Error Browser-&gt;<code>block_name_chf.err</code> 查看 boundary cell、tap cell 是否放置有误<br> tap cell 是否延伸到第一行及最后一行</li>
</ol>
<p>&#x3D;&#x3D;以上检查完成没有问题后，是否 save design as design_name&#x2F;init_design&#x3D;&#x3D;</p>
<h2 id="6-place"><a href="#6-place" class="headerlink" title="6. place"></a>6. place</h2><blockquote>
<p>一般在place阶段停一下，跑完之后查看一下 cell 的排布情况，查看总体的density。<br>如果总体或者某些局部的density没有按照自己的设定 place， 就需要重新来place。<br>如果已经好几个版本了，floorplan的设置以及blockage都已经设置好了，对于整体的placement十分了解，则可以从place直接跑到route_opt</p>
</blockquote>
<p>通过设置<code>placement_blockage</code>来自由的设置不同区域的密度，防止某些区域密度过大或布线资源紧张。</p>
<p>可以设置partial placement blockage后再运行一次<code>place_opt</code>命令</p>
<p>在gui界面Create-&gt;Placement Blockage</p>
<p>Type选择partial，根据需求设置Blocked percentage，然后在相应区域拖出一个矩形</p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121807356.png"></p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121807690.png"></p>
<h2 id="7-place-route-opt"><a href="#7-place-route-opt" class="headerlink" title="7. place -&gt; route_opt"></a>7. place -&gt; route_opt</h2><p><code>route_opt</code>完了之后, 首先检查一下<code>route_congestion</code>.</p>
<h2 id="8-route-opt之后，查看ERROR-修复"><a href="#8-route-opt之后，查看ERROR-修复" class="headerlink" title="8. route_opt之后，查看ERROR &amp; 修复"></a>8. route_opt之后，查看ERROR &amp; 修复</h2><h3 id="查看错误报告"><a href="#查看错误报告" class="headerlink" title="查看错误报告"></a>查看错误报告</h3><p><code>route_opt</code>完成之后, 可以使用run_pr脚本中的<code>open_route_opt</code>命令打开<code>route_opt</code>的block并在GUI中查看。</p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121807366.png"></p>
<p>使用命令检查，并生成报告</p>
<pre class="line-numbers language-none"><code class="language-none">check_routes     # 会生成zroute.error文件，记录了布线的错误（不包含open的错误）
check_lvs          # 生成 设计名_lvs.error 文件， 报告lvs错误 (包含了open的错误)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>&#x3D;&#x3D;打开Error browser查看错误报告&#x3D;&#x3D;</p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121808225.png"></p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121809537.png"></p>
<h3 id="修复错误"><a href="#修复错误" class="headerlink" title="修复错误"></a>修复错误</h3><ol>
<li>修复drc和短路错误</li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">#fix drc &amp; short nets
foreach a [get_attribute [get_drc_errors -error_data [get_drc_error_data zroute.err] -filter &quot;layers.name &#x3D;~ *&quot;] error_id] &#123;
foreach_in_collection net [get_attribute [get_drc_errors -error_data [get_drc_error_data zroute.err] $a] objects] &#123;
if &#123;[get_attr [get_nets $net] net_type] &#x3D;&#x3D; &quot;signal&quot; &amp;&amp; [get_shapes -of_objects [get_nets $net]] !&#x3D; &quot;&quot;&#125; &#123;
remove_shapes [get_shapes -of_objects [get_nets $net]]
remove_vias [get_vias -of_objects [get_nets $net]]
&#125;
&#125;
&#125;
route_detail -incremental true<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="2">
<li>修复lvs和open错误<br>注意把<code>RAM_test</code>修改为自己设计的design_name</li>
</ol>
<pre class="line-numbers language-none"><code class="language-none">#fix lvs open nets
set no_pwr_net &quot;&quot;
foreach a [get_attribute [get_drc_errors -error_data [get_drc_error_data RAM_test_lvs.err] ] error_id] &#123;
foreach_in_collection net [get_attribute [get_drc_errors -error_data [get_drc_error_data RAM_test_lvs.err] $a] objects] &#123;
if &#123;[get_attr [get_nets $net] net_type] &#x3D;&#x3D; &quot;signal&quot;&#125; &#123;
set no_pwr_net [add_to_collection $net $no_pwr_net]
&#125;
&#125;
&#125;
route_eco -nets [get_nets $no_pwr_net]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="9-timing-eco"><a href="#9-timing-eco" class="headerlink" title="9. timing_eco"></a>9. timing_eco</h2><blockquote>
<p>如上面流程图所示, route_opt 完了之后, 需要进行时序修复 timing_eco, 并且可能需要反复进行了修复时序.</p>
</blockquote>
<h3 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h3><ol>
<li>切记,是在跑完了<code>route_opt</code>之后进行的.</li>
<li>进入<code>BACKEND_DIR/starrc</code>文件夹, <code>make starrc</code>进行寄生参数抽取.</li>
<li>然后进入<code>BACKEND_DIR/pt_flow</code>文件夹,<code>make pt</code>进行pt检查时序.<ul>
<li>pt过程中会使用到<code>sdc</code>文件是dc生成的标准语法的<code>sdc</code>文件.</li>
</ul>
</li>
<li>跑完一轮之后,建议在<code>starrc</code>和<code>pt</code>文件夹,执行<code>make backup</code>进行数据备份,以进行不同迭代次数的对比</li>
</ol>
<p><code>timing_eco</code>是从ICC2的block中直接读取数据的,在<code>Makefile_localsetting</code>里面,有设置用来控制pt从icc2的哪个BLOCK中读取数据,并生成<code>eco_changes.tcl</code>,同时设置做完<code>timing_eco</code>之后,保存为新的BLOCK的名字.</p>
<p>多次做<code>timing_eco</code>的步骤,<strong>每次</strong>需要修改<code>Makefile_localsetting</code>的设置,确保是在上一步eco的基础上进行的修改.</p>
<p>例如第一遍pt,两个设置分别是<code>route_opt</code>和<code>timing_eco</code>. 在做第二遍的时候,需要改为<code>timing_eco</code>和<code>timing_eco_1</code>,<strong>然后再进行<code>starrc</code>以及<code>pt</code></strong>.以此类推.</p>
<p>&#x3D;&#x3D;每次timing_eco之后都建议做一遍第8部分所展示的流程，检查ERROR&#x3D;&#x3D;</p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121809408.png"></p>
<h2 id="10-chip-finish-导出文件前设置"><a href="#10-chip-finish-导出文件前设置" class="headerlink" title="10. chip_finish :导出文件前设置"></a>10. chip_finish :导出文件前设置</h2><p><code>timing_eco</code>做完之后，可以准备导出文件了，需要进行一些设置。</p>
<p>通过GUI打开<code>timing_eco</code>完成的BLOCK。</p>
<blockquote>
<p>i ✘ 错误做法: 直接在terminal里面输入 icc2_shell -gui, 然后打开block. 这样会没有脚本中的变量以及 ref_libs 的路径<br>✔ 正确做法: 使用<code>run_pr</code>脚本里面的任意一个<code>open</code>命令, 比如<code>open_route_opt</code>， 会自动加载脚本变量并且打开GUI，然后手动在GUI中打开对应的block即可。</p>
</blockquote>
<h3 id="添加-filler"><a href="#添加-filler" class="headerlink" title="添加 filler"></a>添加 filler</h3><pre class="line-numbers language-none"><code class="language-none">#add filler cells
set_app_options  -name place.legalize.enable_advanced_legalizer  -value  false
set CHIP_FINISH_NON_METAL_FILLER_LIB_CELL_LIST  &quot; FILL64BWP30P140 FILL32BWP30P140 FILL16BWP30P140 FILL8BWP30P140 FILL4BWP30P140 FILL3BWP30P140 FILL2BWP30P140&quot;
set create_stdcell_filler_non_metal_lib_cell_sorted [get_object_name [sort_collection -descending [get_lib_cells $CHIP_FINISH_NON_METAL_FILLER_LIB_CELL_LIST] area]]
set create_stdcell_filler_non_metal_cmd &quot;create_stdcell_filler -lib_cell [list $create_stdcell_filler_non_metal_lib_cell_sorted]&quot;
puts &quot;RM-info: $create_stdcell_filler_non_metal_cmd&quot;
eval $&#123;create_stdcell_filler_non_metal_cmd&#125;
connect_pg_net<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="添加via12"><a href="#添加via12" class="headerlink" title="添加via12"></a>添加via12</h3><pre class="line-numbers language-none"><code class="language-none">#add via12
set pwr_name VDD
set grd_name VSS
set_app_options -name plan.pgroute.via_site_threshold  -value 1
set_app_options -name plan.pgroute.disable_via_creation  -value false
create_pg_vias  -within_bbox [get_attr [get_blocks] bbox] \
	 -nets &quot;$pwr_name $grd_name&quot;  \
	 -from_types lib_cell_pin_connect \
	 -from_layers M1  \
 	 -to_layers M2 \
	 -allow_parallel_objects \
	 -blockage &quot;pg_regions : [get_attribute [get_pg_regions &quot;powerMemRegion1_*&quot;] full_name ]&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="手动添加VDD-VSS-terminal"><a href="#手动添加VDD-VSS-terminal" class="headerlink" title="手动添加VDD VSS terminal"></a>手动添加VDD VSS terminal</h3><p>选中最高层金属的电源条线(选中任意一条)， <code>Create Terminal</code>, 设置Port为VDD&#x2F;VSS，Name为VDD&#x2F;VSS，Layer为对应的金属层。例如电源条线为M8时：</p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121809424.png"></p>
<h3 id="手动添加VDD-VSS-text"><a href="#手动添加VDD-VSS-text" class="headerlink" title="手动添加VDD VSS text"></a>手动添加VDD VSS text</h3><p>Create Text，设置Text为VDD&#x2F;VSS，Layer为对应金属层(最好放在对应的电源线上，方便识别)：</p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121810659.png"></p>
<h3 id="导出文件，保存block为-chip-finish"><a href="#导出文件，保存block为-chip-finish" class="headerlink" title="导出文件，保存block为 chip_finish"></a>导出文件，保存block为 chip_finish</h3><p>执行<code>write_verilog</code>及<code>write_gds</code>，写出网表和版图供lvs、drc使用，注意替换<code>design_name</code>。导出的文件路径为<code>pnr/outputs_icc2/</code></p>
<p><code>source ./user_scripts/dumExcl.tcl</code>，在当前目录下生成<code>dumExcl.list</code>供后续生成dummy使用</p>
<p>save as <code>design_name/chip_finish</code></p>
<p>&#x3D;&#x3D;注意修改命令中的DESIGN_NAME&#x3D;&#x3D;</p>
<p>该命令在<code>user_scripts/ref_cmd.tcl</code>里面有参考示例。</p>
<pre class="line-numbers language-none"><code class="language-none">#write_verilog for LVS (with pg, and with physical only cells)
write_verilog -compress gzip -exclude &#123;scalar_wire_declarations leaf_module_declarations empty_modules&#125; -force_no_reference &#123;FILL16BWP30P140 FILL2BWP30P140 FILL32BWP30P140 FILL3BWP30P140 FILL4BWP30P140 FILL64BWP30P140 FILL8BWP30P140 TAPCELLBWP30P140 BOUNDARY_LEFTBWP30P140 BOUNDARY_RIGHTBWP30P140 N28_DMY_TCD_FV BEOL_small_FDM1 BEOL_small_FDM2 BEOL_small_FDM3 BEOL_small_FDM4 BEOL_small_FDM5 BEOL_small_FDM6&#125; -hierarchy all YOUR_DESIGN_NAME.lvs.v
# write_gds
set_app_options -name file.gds.text_all_pins -value true
set WRITE_GDS_LAYER_MAP_FILE &#x2F;foundry&#x2F;22ULL&#x2F;TSMC22lib&#x2F;technology&#x2F;tf&#x2F;GdsOutMap&#x2F;PRTF_ICC2_22nm_8M_5X2Z.11_1a.map
write_gds -compress -hierarchy all -long_names -units 1000 -keep_data_type YOUR_DESIGN_NAME.gds -layer_map $WRITE_GDS_LAYER_MAP_FILE<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="11-输出全部文件"><a href="#11-输出全部文件" class="headerlink" title="11. 输出全部文件"></a>11. 输出全部文件</h2><h3 id="导出verilog，gds等相关文件"><a href="#导出verilog，gds等相关文件" class="headerlink" title="导出verilog，gds等相关文件"></a>导出verilog，gds等相关文件</h3><p>在<code>run_pr</code>里面， 使用<code>write_data</code>命令。如果没有的话，自己手动添加即可。在设计完成之后，执行该命令可以一次性输出所有的相关文件。</p>
<p><del>这个命令是从<code>timing_eco_block</code>输出的文件。即上面<code>timing_eco</code>步骤的最终一个block。</del></p>
<p>在<code>Makefile_localsettings</code>里面, 需要确认有变量<code>write_data_from_block_name</code>. <code>write_data</code>命令从该变量所指定的block中导出数据.</p>
<p>导出文件的路径位<code>output_icc2/&lt;VERSION&gt;</code>文件夹</p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121810216.png"></p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121810513.png"></p>
<h3 id="导出ndm"><a href="#导出ndm" class="headerlink" title="导出ndm"></a>导出ndm</h3><pre class="line-numbers language-none"><code class="language-none">source .&#x2F;rm_icc2_pnr_scripts&#x2F;etm_generation.tcl<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>&#x3D;&#x3D;注意&#x3D;&#x3D;<br>source脚本&#x3D;&#x3D;之前&#x3D;&#x3D;，请确保<code>pnr</code>路径下有<code>in_design_starrc.cgf</code>和<code>starRC.cmd</code>文件链接。<br>如果没有的话，需要在项目路径(rtl同级目录) <code>make update &amp;&amp; make update_tmp</code><br><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121811969.png"></p>
</blockquote>
<p>顺利跑完脚本的话， 会在pnr路径下生成<code>/ETM_Lib_work_dir/</code>文件夹，以ISP项目为例，<code>/ETM_Lib_work_dir/D8M_ISP/route_opt/D8M_ISP</code>就是ndm文件(其实是个文件夹)，里面的内容如图所示。</p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121812445.png"></p>
<h2 id="12-calibre-flow"><a href="#12-calibre-flow" class="headerlink" title="12. calibre flow"></a>12. calibre flow</h2><p>工作路径：<code>BACKEND/calibre_flow</code>文件夹</p>
<p>恢复初始：<code>make clean</code></p>
<p>包含指令：<code>make v2lvs</code>, <code>make gds_merge</code> , <code>make check_lvs</code>, <code>make check_drc</code> 等</p>
<h3 id="一键执行"><a href="#一键执行" class="headerlink" title="一键执行"></a>一键执行</h3><p>在<code>calibre_flow</code>文件夹，直接执行<code>make</code>. 会一键执行以下的所有步骤. 建议先分步执行，熟悉流程之后再使用该命令一键执行.</p>
<h3 id="步骤一：v2lvs"><a href="#步骤一：v2lvs" class="headerlink" title="步骤一：v2lvs"></a>步骤一：v2lvs</h3><p>在工作路径执行: <code>make v2lvs</code></p>
<p>目的是将 <code>pnr</code>生成的<code>verilog</code>文件转为<code>cdl</code>文件， 用于后续的 <code>lvs</code>检查.</p>
<p>此步骤需要注意的地方：</p>
<ol>
<li>需要的文件为pnr生成的<code>output_icc2/VERSION/write_data.lvs.v.gz</code>，脚本会读取此文件，如果文件名不一致的话会报错</li>
<li>sram的<code>cdl</code>列表，是依据sram的ndm列表生成的，请确保<code>Makefile_localsetting</code>设置无误</li>
</ol>
<h3 id="步骤二：merge"><a href="#步骤二：merge" class="headerlink" title="步骤二：merge"></a>步骤二：merge</h3><p>&#x3D;&#x3D;子模块merge&#x3D;&#x3D;</p>
<p>在工作路径执行: <code>make gds_merge</code></p>
<p>目的是将<code>icc2</code>导出的gds，std的gds以及sram的gds合并到一起，得到最终的包含所有信息的gds。</p>
<p>&#x3D;&#x3D;顶层merge&#x3D;&#x3D;</p>
<p>在工作路径执行: <code>make top_gds_merge</code></p>
<p>此步骤需要注意的地方：</p>
<ol>
<li>需要的文件为pnr生成的<code>output_icc2/VERSION/write_data.gds.gz</code>，脚本会读取此文件，如果文件名不一致的话会报错</li>
</ol>
<h3 id="步骤三：加dummy（省略）"><a href="#步骤三：加dummy（省略）" class="headerlink" title="步骤三：加dummy（省略）"></a>步骤三：加dummy（省略）</h3><p>22nm的不需要添加dummy，foundry会帮我们添加。</p>
<h3 id="步骤四：check-lvs"><a href="#步骤四：check-lvs" class="headerlink" title="步骤四：check_lvs"></a>步骤四：check_lvs</h3><p>在工作路径执行: <code>make check_lvs</code>.</p>
<blockquote>
<p>w 由于上面的命令是完全在命令行进行检查的，只能在log中来检查错误，不是很直观。主要是为了最终要finish的时候，做最后一轮检查。<br>实际工作中，使用GUI来进行操作，比较方便直观。<br>可以使用<code>make ./script/calibre.lvs</code>生成对应的lvs rule，然后按照下面的步骤，在GUI中依次执行。</p>
</blockquote>
<p>步骤如下：</p>
<ol>
<li><code>cd work_lvs</code></li>
<li>calibredrv 打开calibredrv图形界面</li>
<li>File-&gt;Open Layout Files选择<code>gds_merge/design_name.merge.gds</code></li>
<li>Verification-&gt;Run nmLVS</li>
<li>设置Rules-&gt;LVS Rules File</li>
<li>设置Inputs-&gt;Layout File、Netlist、H-Cells</li>
<li>设置Run Control-&gt;Run Calibre-&gt;Multi-Threaded</li>
</ol>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121812626.png"></p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121812033.png"></p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121812561.png"></p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121813190.png"></p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121813335.png"></p>
<h3 id="步骤五：check-drc"><a href="#步骤五：check-drc" class="headerlink" title="步骤五：check_drc"></a>步骤五：check_drc</h3><p>在工作路径执行: <code>make check_drc</code></p>
<blockquote>
<p>w 由于上面的命令是完全在命令行进行检查的，只能在log中来检查错误，不是很直观。主要是为了最终要finish的时候，做最后一轮检查。<br>实际工作中，使用GUI来进行操作，比较方便直观。<br>可以使用<code>make ./script/calibre.drc</code>生成对应的drc rule, 然后使用GUI进行操作。</p>
</blockquote>
<p>步骤如下：</p>
<ol>
<li><code>cd work_drc</code></li>
<li>calibredrv 打开calibredrv图形界面</li>
<li>File-&gt;Open Layout Files选择<code>gds_merge/design_name.merge.gds</code></li>
<li>Verification-&gt;Run nmDRC</li>
<li>设置Rules-&gt;DRC Rules File</li>
<li>设置Inputs-&gt;Layout File</li>
<li>设置Run Control-&gt;Run Calibre-&gt;Multi-Threaded</li>
</ol>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121813510.png"></p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121813931.png"></p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121813114.png"></p>
<h4 id="在icc2中打开drc报告"><a href="#在icc2中打开drc报告" class="headerlink" title="在icc2中打开drc报告"></a>在icc2中打开drc报告</h4><blockquote>
<p>涉及命令: <code>read_drc_error_file -file &lt;DRC_REPORT&gt;</code></p>
</blockquote>
<p>在上一步执行完了drc并生成报告之后， 可以在drc的工作目录找到<code>module_name.drc.results</code>文件</p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121813256.png"></p>
<p>打开<code>route_opt</code>或者<code>chip_finish</code>的block，导入相应设计的<code>drc.results</code>，命令如下：<code>read_drc_error_file -file &lt;DRC_REPORT&gt;</code></p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121814463.png"></p>
<p>Error browse中，File-&gt;Open打开error data</p>
<p><img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121814063.png"></p>
<p>这样在ICC2里面就可以查看DRC的结果了</p>
<h2 id="13-错误报告"><a href="#13-错误报告" class="headerlink" title="13.错误报告"></a>13.错误报告</h2><p><a target="_blank" rel="noopener" href="http://175.178.45.34:10086/project-8/doc-30/">点击查看:TSMC22后端常见问题总结</a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Sugar</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://blog.sugarlovestudy.club/posts/20240812175825.html">https://blog.sugarlovestudy.club/posts/20240812175825.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Sugar</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E5%90%8E%E7%AB%AF/">
                                    <span class="chip bg-color">后端</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="qq,wechat,weibo,douban" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/posts/20240812181447.html">
                    <div class="card-image">
                        
                        <img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121825280.png" class="responsive-img" alt="IC后端-TSMC22后端常见问题总结">
                        
                        <span class="card-title">IC后端-TSMC22后端常见问题总结</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2024-08-12
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E8%8A%AF%E7%89%87%E8%AE%BE%E8%AE%A1/" class="post-category">
                                    芯片设计
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%90%8E%E7%AB%AF/">
                        <span class="chip bg-color">后端</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/20240812102720.html">
                    <div class="card-image">
                        
                        <img src="https://cdn.jsdmirror.com/gh/sustcsugar/picgo/img/2024/08/202408121143213.png" class="responsive-img" alt="picgo图床+CDN加速">
                        
                        <span class="card-title">picgo图床+CDN加速</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2024-08-12
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/" class="post-category">
                                    技术文章
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E8%BD%AF%E4%BB%B6/">
                        <span class="chip bg-color">软件</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>





    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2024</span>
            
            <span id="year">2024</span>
            <a href="/about" target="_blank">Sugar</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">














    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
